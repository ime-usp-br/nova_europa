#!/usr/bin/env bash

# =============================================================================
# Nova Europa - Container Startup Script (Production)
# =============================================================================
# This script runs when the container starts and performs initialization tasks:
# - Configures FreeTDS with environment variables
# - Sets up Puppeteer/Chrome if needed
# - Adjusts file permissions
# - Starts supervisor or executes custom commands
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# =============================================================================
# 1. Configure FreeTDS
# =============================================================================
log_info "Configuring FreeTDS for Replicado connection..."

REPLICADO_HOST_VAL=${REPLICADO_HOST:-200.144.255.61}
REPLICADO_PORT_VAL=${REPLICADO_PORT:-62433}

sed -e "s/__REPLICADO_HOST__/$REPLICADO_HOST_VAL/g" \
    -e "s/__REPLICADO_PORT__/$REPLICADO_PORT_VAL/g" \
    /etc/freetds/freetds.conf.template > /etc/freetds/freetds.conf

log_info "FreeTDS configured: $REPLICADO_HOST_VAL:$REPLICADO_PORT_VAL"

# =============================================================================
# 2. Validate Supervisor User
# =============================================================================
if [ "$SUPERVISOR_PHP_USER" != "root" ] && [ "$SUPERVISOR_PHP_USER" != "www-data" ]; then
    log_error "SUPERVISOR_PHP_USER must be 'www-data' or 'root'"
    exit 1
fi

# =============================================================================
# 3. Adjust User ID if needed
# =============================================================================
if [ ! -z "$WWWUSER" ] && [ "$WWWUSER" != "1000" ]; then
    log_info "Adjusting www-data UID to $WWWUSER"
    usermod -u $WWWUSER www-data
fi

# =============================================================================
# 4. Setup Composer Cache Directory
# =============================================================================
if [ ! -d /.composer ]; then
    mkdir -p /.composer
fi
chmod -R ugo+rw /.composer

# =============================================================================
# 5. Install Chrome Headless Shell for Puppeteer
# =============================================================================
# This installs Chrome matching the puppeteer-core version
# We only install if not already installed (marker file check)

if [ ! -f /var/www/.cache/puppeteer/.chrome-installed ]; then
    log_info "Installing Chrome Headless Shell for Puppeteer..."

    # Ensure cache directory exists with correct permissions
    mkdir -p /var/www/.cache/puppeteer
    chown -R www-data:www-data /var/www/.cache/puppeteer

    # Get the expected Chrome version from puppeteer-core
    CHROME_VERSION=$(gosu www-data node -e "console.log(require('/var/www/html/node_modules/puppeteer-core/lib/cjs/puppeteer/revisions.js').PUPPETEER_REVISIONS['chrome-headless-shell'])" 2>/dev/null || echo "")

    if [ -n "$CHROME_VERSION" ]; then
        log_info "Detected Chrome version: $CHROME_VERSION"
        gosu www-data npx puppeteer browsers install chrome-headless-shell@$CHROME_VERSION

        if [ $? -eq 0 ]; then
            gosu www-data touch /var/www/.cache/puppeteer/.chrome-installed
            log_info "Chrome Headless Shell installed successfully"
        else
            log_error "Failed to install Chrome Headless Shell"
            exit 1
        fi
    else
        log_warn "Could not detect Chrome version from puppeteer-core"
        log_info "Installing latest Chrome Headless Shell..."
        gosu www-data npx puppeteer browsers install chrome-headless-shell

        if [ $? -eq 0 ]; then
            gosu www-data touch /var/www/.cache/puppeteer/.chrome-installed
            log_info "Chrome Headless Shell installed successfully"
        else
            log_error "Failed to install Chrome Headless Shell"
            exit 1
        fi
    fi
else
    log_info "Chrome Headless Shell already installed, skipping..."
fi

# =============================================================================
# 6. Fix Permissions for Laravel Storage
# =============================================================================
log_info "Adjusting storage and cache permissions..."

chown -R www-data:www-data /var/www/html/storage
chown -R www-data:www-data /var/www/html/bootstrap/cache
chmod -R 775 /var/www/html/storage
chmod -R 775 /var/www/html/bootstrap/cache

# =============================================================================
# 7. Execute Command
# =============================================================================
if [ $# -gt 0 ]; then
    log_info "Executing custom command: $@"
    if [ "$SUPERVISOR_PHP_USER" = "root" ]; then
        exec "$@"
    else
        exec gosu $WWWUSER "$@"
    fi
else
    log_info "Starting Supervisor..."
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
