#!/usr/bin/env bash

# =============================================================================
# Nova Europa - Container Startup Script (Production)
# =============================================================================
# This script runs when the container starts and performs initialization tasks:
# - Configures FreeTDS with environment variables
# - Sets up Puppeteer/Chrome if needed
# - Adjusts file permissions
# - Starts supervisor or executes custom commands
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# =============================================================================
# 1. Configure PHP-FPM allowed clients based on Docker network
# =============================================================================
log_info "Configuring PHP-FPM network access..."

# Extract network subnet from environment (e.g., 172.27.0.0/16)
DOCKER_SUBNET=${DOCKER_NETWORK_SUBNET:-172.27.0.0/16}

# If subnet is defined, configure allowed clients; otherwise, allow all
if [ -n "$DOCKER_SUBNET" ]; then
    log_info "PHP-FPM will accept connections from: $DOCKER_SUBNET"
    # Uncomment the line and set the correct subnet
    sed -i "s|^;\?listen.allowed_clients = .*|listen.allowed_clients = $DOCKER_SUBNET|" /etc/php/8.2/fpm/pool.d/www.conf
else
    log_info "PHP-FPM will accept connections from any IP (no restriction)"
    # Comment out the line to allow all connections
    sed -i "s|^listen.allowed_clients = .*|;listen.allowed_clients = |" /etc/php/8.2/fpm/pool.d/www.conf
fi

# =============================================================================
# 2. Configure FreeTDS
# =============================================================================
log_info "Configuring FreeTDS for Replicado connection..."

REPLICADO_HOST_VAL=${REPLICADO_HOST:-200.144.255.61}
REPLICADO_PORT_VAL=${REPLICADO_PORT:-62433}

sed -e "s/__REPLICADO_HOST__/$REPLICADO_HOST_VAL/g" \
    -e "s/__REPLICADO_PORT__/$REPLICADO_PORT_VAL/g" \
    /etc/freetds/freetds.conf.template > /etc/freetds/freetds.conf

log_info "FreeTDS configured: $REPLICADO_HOST_VAL:$REPLICADO_PORT_VAL"

# =============================================================================
# 3. Validate Supervisor User
# =============================================================================
if [ "$SUPERVISOR_PHP_USER" != "root" ] && [ "$SUPERVISOR_PHP_USER" != "www-data" ]; then
    log_error "SUPERVISOR_PHP_USER must be 'www-data' or 'root'"
    exit 1
fi

# =============================================================================
# 4. Adjust User ID if needed
# =============================================================================
if [ ! -z "$WWWUSER" ] && [ "$WWWUSER" != "1000" ]; then
    log_info "Adjusting www-data UID to $WWWUSER"
    usermod -u $WWWUSER www-data
fi

# =============================================================================
# 5. Setup Composer Cache Directory
# =============================================================================
if [ ! -d /.composer ]; then
    mkdir -p /.composer
fi
chmod -R ugo+rw /.composer

# =============================================================================
# 6. Fix Permissions for Laravel Storage
# =============================================================================
log_info "Adjusting storage and cache permissions..."

chown -R www-data:www-data /var/www/html/storage
chown -R www-data:www-data /var/www/html/bootstrap/cache
chmod -R 775 /var/www/html/storage
chmod -R 775 /var/www/html/bootstrap/cache

# =============================================================================
# 7. Execute Command
# =============================================================================
if [ $# -gt 0 ]; then
    log_info "Executing custom command: $@"
    if [ "$SUPERVISOR_PHP_USER" = "root" ]; then
        exec "$@"
    else
        exec gosu $WWWUSER "$@"
    fi
else
    log_info "Starting Supervisor..."
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
